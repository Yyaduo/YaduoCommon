# .github/workflows/auto-release.yml
name: è‡ªåŠ¨å‘å¸ƒRelease

# è§¦å‘æ¡ä»¶ï¼šPushåˆ°ç›®æ ‡åˆ†æ”¯
on:
  push:
    branches: [
      main,
      master,
      release-branch-v*,
    ]
    # åªç›‘å¬ç›¸å…³æ–‡ä»¶å˜æ›´æ—¶è§¦å‘å¹¶æ’é™¤æœ¬æ–‡ä»¶ä¿®æ”¹è§¦å‘
    paths:
      - 'app/build.gradle.kts'
      - 'common/build.gradle.kts'
      - 'gradle.properties'
      - '**.toml'
      - '**.kt'
      - '**.java'
      - '!.github/workflows/auto-release.yml'

# é…ç½®å·¥ä½œæµæƒé™
permissions:
  contents: write  # å…è®¸è¯»å†™ä»“åº“å†…å®¹ï¼ˆåˆ›å»ºTag/Releaseï¼‰
  packages: write   # å‘å¸ƒGitHub Packageséœ€è¦çš„æƒé™

jobs:
  auto-release:
    runs-on: ubuntu-latest  # ç¼–è¯‘ç¯å¢ƒ
    # å¤±è´¥æ—¶ç«‹å³ç»ˆæ­¢ï¼Œé¿å…æ— æ•ˆæ­¥éª¤
    continue-on-error: false
    # è¾“å‡ºå˜é‡ç»™åç»­å‘å¸ƒjob
    outputs:
      TAG_EXISTS: ${{ steps.check_tag.outputs.TAG_EXISTS }}
      TAG_NAME: ${{ steps.get_version.outputs.TAG_NAME }}
      VERSION_NAME: ${{ steps.get_version.outputs.VERSION_NAME }}
      RELEASE_TITLE: ${{ steps.get_version.outputs.RELEASE_TITLE }}
    steps:
      # æ­¥éª¤1ï¼šæ‹‰å–ä»“åº“ä»£ç 
      - name: step_one -> æ‹‰å–ä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # æ‹‰å–æ‰€æœ‰å†å²ï¼Œæ–¹ä¾¿åˆ›å»ºTag
          # é…ç½®gitç”¨æˆ·ï¼ˆæå‰é…ç½®ï¼Œé¿å…åç»­é‡å¤ï¼‰
          persist-credentials: true

      # æ­¥éª¤2ï¼šè¯»å–ç‰ˆæœ¬å·
      - name: step_two -> è¯»å–ç‰ˆæœ¬å·
        id: get_version
        run: |
          # ä»»æ„å‘½ä»¤å¤±è´¥ç«‹å³é€€å‡º
          set -e 
          
          # ========== è¯»å–gradle.properties ==========
          # è¿‡æ»¤å‡ºVERSION_NAMEè¡Œ
          VERSION_LINE=$(grep '^VERSION_NAME=' gradle.properties)
          # æŒ‰ç­‰å·åˆ†å‰²ï¼Œå–ååŠéƒ¨åˆ†ï¼Œå»æ‰é¦–å°¾ç©ºæ ¼
          VERSION_NAME=$(echo "$VERSION_LINE" | cut -d'=' -f2 | tr -d ' ' | tr -d '\t')
          
          # ========== å¤‡ç”¨ï¼šè¯»å–build.gradle.kts==========
          if [ -z "$VERSION_NAME" ]; then
            echo "æœªä»gradle.propertiesè¯»å–ç‰ˆæœ¬å·ï¼Œå°è¯•è¯»å–common/build.gradle.kts..."
            # è¿‡æ»¤versionè¡Œ + æŒ‰å¼•å·åˆ†å‰² + å»ç©ºæ ¼
            VERSION_LINE=$(grep 'version =' common/build.gradle.kts | head -1)
            VERSION_NAME=$(echo "$VERSION_LINE" | cut -d'"' -f2 | tr -d ' ' | tr -d '\t')
          fi
          
          # æœ€ç»ˆæ ¡éªŒç‰ˆæœ¬å·
          if [ -z "$VERSION_NAME" ]; then
            echo "ERROR: æœªä»gradle.propertiesæˆ–build.gradle.ktsè¯»å–åˆ°ç‰ˆæœ¬å·ï¼"
            exit 1
          fi
          
          # ç”Ÿæˆå‘å¸ƒç›¸å…³å˜é‡
          TODAY_DATE=$(date +'%Y.%m.%d')
          TAG_NAME=release-v${VERSION_NAME}
          RELEASE_TITLE="${VERSION_NAME}-${TODAY_DATE}"
          
          # è¾“å‡ºå˜é‡ï¼ˆå…³é”®ï¼šè¡¥å……TODAY_DATEè¾“å‡ºï¼‰
          echo "VERSION_NAME=${VERSION_NAME}" >> $GITHUB_OUTPUT
          echo "TAG_NAME=${TAG_NAME}" >> $GITHUB_OUTPUT
          echo "RELEASE_TITLE=${RELEASE_TITLE}" >> $GITHUB_OUTPUT
          echo "TODAY_DATE=${TODAY_DATE}" >> $GITHUB_OUTPUT
          
          # æ‰“å°æ—¥å¿—ï¼ˆä¾¿äºæ’æŸ¥é—®é¢˜ï¼‰
          echo "===== å‘å¸ƒä¿¡æ¯ ====="
          echo "ç‰ˆæœ¬å·ï¼š${VERSION_NAME}"
          echo "Tagåç§°ï¼š${TAG_NAME}"
          echo "Releaseæ ‡é¢˜ï¼š${RELEASE_TITLE}"
          echo "å‘å¸ƒæ—¥æœŸï¼š${TODAY_DATE}"
          echo "===================="

      # æ­¥éª¤3ï¼šæ£€æŸ¥Tagæ˜¯å¦å·²å­˜åœ¨ï¼ˆé¿å…é‡å¤å‘å¸ƒï¼‰
      - name: step_three -> æ£€æŸ¥Tagæ˜¯å¦å­˜åœ¨
        id: check_tag
        run: |
          if git rev-parse "refs/tags/${{ steps.get_version.outputs.TAG_NAME }}" >/dev/null 2>&1; then
            echo "TAG_EXISTS=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ Tag ${{ steps.get_version.outputs.TAG_NAME }} å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º"
          else
            echo "TAG_EXISTS=false" >> $GITHUB_OUTPUT
            echo "âœ… Tag ${{ steps.get_version.outputs.TAG_NAME }} ä¸å­˜åœ¨ï¼Œå‡†å¤‡åˆ›å»º"
          fi

      # æ­¥éª¤4ï¼šåˆ›å»ºTagï¼ˆä»…Tagä¸å­˜åœ¨æ—¶æ‰§è¡Œï¼‰
      - name: step_four -> åˆ›å»ºGit Tag
        id: build_release
        if: steps.check_tag.outputs.TAG_EXISTS == 'false'
        run: |
          set -e
          # 1. è·å–æœ¬æ¬¡æäº¤çš„ä½œè€…åç§°ï¼Œå…œåº•ç”¨GitHub Actor
          COMMIT_AUTHOR_NAME="${{ github.event.head_commit.author.name || github.actor }}"
          # 2. è·å–æœ¬æ¬¡æäº¤çš„ä½œè€…é‚®ç®±ï¼Œå…œåº•ç”¨ GitHub å®˜æ–¹noreplyé‚®ç®±
          COMMIT_AUTHOR_EMAIL="${{ github.event.head_commit.author.email }}"
          if [ -z "$COMMIT_AUTHOR_EMAIL" ]; then
            COMMIT_AUTHOR_EMAIL="${{ github.actor }}@users.noreply.github.com"
          fi
          
          git config --global user.name "$COMMIT_AUTHOR_NAME"
          git config --global user.email "$COMMIT_AUTHOR_EMAIL"
          
          # è¾“å‡ºæäº¤çš„ç”¨æˆ·ä¿¡æ¯
          echo "commit_author_name=${COMMIT_AUTHOR_NAME}" >> $GITHUB_OUTPUT
          echo "commit_author_email=${COMMIT_AUTHOR_EMAIL}" >> $GITHUB_OUTPUT
          
          # æ‰“å°é…ç½®çš„ç”¨æˆ·ä¿¡æ¯
          echo "ğŸ”§ é…ç½®çš„Gitç”¨æˆ·ä¿¡æ¯ï¼š"
          echo "   åç§°ï¼š$COMMIT_AUTHOR_NAME"
          echo "   é‚®ç®±ï¼š$COMMIT_AUTHOR_EMAIL"
          
          TAG_NAME="${{ steps.get_version.outputs.TAG_NAME }}"
          RELEASE_TITLE="${{ steps.get_version.outputs.RELEASE_TITLE }}"
          git tag -a "$TAG_NAME" -m "Release $RELEASE_TITLE"
          
          # æ¨é€Tag
          for i in {1..3}; do
            if git push origin ${{ steps.get_version.outputs.TAG_NAME }}; then
              echo "âœ… Tagæ¨é€æˆåŠŸ"
              break
            else
              echo "âš ï¸ Tagæ¨é€å¤±è´¥ï¼Œç¬¬${i}æ¬¡é‡è¯•..."
              sleep 2
              if [ $i -eq 3 ]; then
                echo "âŒ Tagæ¨é€3æ¬¡å¤±è´¥ï¼Œç»ˆæ­¢æµç¨‹"
                exit 1
              fi
            fi
          done

      # æ­¥éª¤5ï¼šåˆ›å»ºGitHub Releaseï¼ˆè‡ªåŠ¨å¡«å……Tag/Title/åˆ†æ”¯ï¼‰
      - name: step_five -> åˆ›å»ºRelease
        if: steps.check_tag.outputs.TAG_EXISTS == 'false'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.get_version.outputs.TAG_NAME }}
          name: ${{ steps.get_version.outputs.RELEASE_TITLE }}  # ä½¿ç”¨å¸¦æ—¥æœŸçš„æ ‡é¢˜
          target_commitish: ${{ github.ref_name }}
          # æ˜¾å¼é…ç½®å‘å¸ƒç±»å‹ï¼ˆéè‰ç¨¿/éé¢„å‘å¸ƒï¼‰
          draft: false
          prerelease: false
          body: |
            ## ${{ github.event.repository.name }} : ${{ steps.get_version.outputs.RELEASE_TITLE }}
            - å‘å¸ƒåˆ†æ”¯ï¼š${{ github.ref_name }}
            - æäº¤å“ˆå¸Œï¼š${{ github.sha }}
            - å‘å¸ƒæ—¥æœŸï¼š${{ steps.get_version.outputs.TODAY_DATE }}
            - ä»£ç æäº¤ä½œè€…ï¼š${{ steps.build_release.outputs.commit_author_name }} <${{ steps.build_release.outputs.commit_author_email }}>
            - Release åˆ›å»ºè€…ï¼šGitHub Actionsï¼ˆè‡ªåŠ¨åŒ–å‘å¸ƒï¼‰
            - æäº¤ä¿¡æ¯ï¼š${{ github.event.head_commit.message || 'æ— æäº¤ä¿¡æ¯' }}
            - JitPackä¾èµ–ç¤ºä¾‹ï¼š
              ```gradle
              dependencies {
                  implementation 'com.github.${{ github.repository_owner }}:${{ github.event.repository.name }}:${{ steps.get_version.outputs.TAG_NAME }}'
              }
              ```
              ```toml
              [libraries]
              yaduo-common = { module = "com.github.Yyaduo:YaduoCommon", version.ref = "yaduocommon" }
            
              [versions]
              yaduocommon = "${{ steps.get_version.outputs.TAG_NAME }}"
              ```

  # è§¦å‘JitPackç¼–è¯‘
  trigger-jitpack-build:
    runs-on: ubuntu-latest
    continue-on-error: false
    # ä»…ä¸»auto-releaseæˆåŠŸä¸”Tagä¸å­˜åœ¨æ—¶æ‰§è¡Œ
    needs: auto-release
    if: needs.auto-release.outputs.TAG_EXISTS == 'false' && needs.auto-release.result == 'success'
    steps:
      - name: step_one -> æ‹‰å–ä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: step_two -> è§¦å‘JitPackç¼–è¯‘
        run: |
          set +e
          REPO_FULL_NAME="${{ github.repository }}"
          TAG_NAME="${{ needs.auto-release.outputs.TAG_NAME }}"
          JITPACK_API_URL="https://jitpack.io/api/builds/${REPO_FULL_NAME}/${TAG_NAME}"
          JITPACK_CHECK_URL="https://jitpack.io/com/github/${{ github.repository_owner }}/${{ github.event.repository.name }}/${TAG_NAME}"
          JITPACK_REPO_URL="https://jitpack.io/#${REPO_FULL_NAME}"
  
          echo "===== è§¦å‘JitPackç¼–è¯‘ ====="
          echo "ä»“åº“åœ°å€ï¼š${REPO_FULL_NAME}"
          echo "Tagç‰ˆæœ¬ï¼š${TAG_NAME}"
          echo "JitPack APIï¼š${JITPACK_API_URL}"
          echo "============================"
  
          echo "â³ ç­‰å¾…90ç§’ï¼Œè®©JitPackåŒæ­¥GitHubçš„Tagå’ŒRelease..."
          sleep 90
  
          echo "ğŸ”„ å¼ºåˆ¶åˆ·æ–°JitPackä»“åº“æ•°æ®..."
          curl -s --connect-timeout 20 --max-time 40 -k "$JITPACK_REPO_URL" > /dev/null
  
          TAG_FOUND=false
          for i in {1..2}; do
            echo "ğŸ” ç¬¬${i}æ¬¡æ£€æŸ¥JitPackæ˜¯å¦è¯†åˆ«Tag..."
            CHECK_RESPONSE=$(curl -s --connect-timeout 20 --max-time 60 -k "$JITPACK_CHECK_URL")
            CURL_EXIT_CODE=$?
            if [ $CURL_EXIT_CODE -ne 0 ]; then
              echo "âš ï¸ ç¬¬${i}æ¬¡æ£€æŸ¥ï¼šcurlè¯·æ±‚å¤±è´¥ï¼Œ20ç§’åé‡è¯•..."
              sleep 20
              continue
            fi
            if echo "$CHECK_RESPONSE" | grep -qi "not found"; then
              echo "âš ï¸ ç¬¬${i}æ¬¡æ£€æŸ¥ï¼šJitPackæœªè¯†åˆ«åˆ°Tagï¼Œ20ç§’åé‡è¯•..."
              sleep 20
            else
              echo "âœ… JitPackå·²è¯†åˆ«åˆ°Tagï¼Œå¼€å§‹è§¦å‘ç¼–è¯‘..."
              TAG_FOUND=true
              break
            fi
          done
          
          if [ "$TAG_FOUND" = false ]; then
            echo "âš ï¸ JitPack Tagæ£€æŸ¥å¤±è´¥ï¼Œç›´æ¥å°è¯•è§¦å‘ç¼–è¯‘..."
          fi
          
          BUILD_SUCCESS=false
          for i in {1..3}; do
            echo "ğŸ“¡ ç¬¬${i}æ¬¡å°è¯•è§¦å‘JitPackç¼–è¯‘..."
            RESPONSE=$(curl -s -X POST \
              --connect-timeout 20 \
              --max-time 60 \
              -k \
              -H "User-Agent: GitHub Actions/${{ github.run_id }} (${{ github.actor }})" \
              -H "Accept: application/json" \
              "$JITPACK_API_URL")
            CURL_EXIT_CODE=$?
            if [ $CURL_EXIT_CODE -ne 0 ]; then
              echo "âš ï¸ ç¬¬${i}æ¬¡è§¦å‘ï¼šcurlè¯·æ±‚å¤±è´¥ï¼Œ20ç§’åé‡è¯•..."
              sleep 20
              continue
            fi
            echo "ğŸ“ JitPackå“åº”ï¼š${RESPONSE:-"ç©ºå“åº”"}"
            if [ -n "$RESPONSE" ] && echo "$RESPONSE" | grep -qiE "Building|Queued|Success|Created|Found"; then
              echo "âœ… JitPackç¼–è¯‘è§¦å‘æˆåŠŸï¼"
              BUILD_SUCCESS=true
              break
            else
              echo "âš ï¸ ç¬¬${i}æ¬¡è§¦å‘ï¼šå“åº”æ— æ•ˆï¼Œ20ç§’åé‡è¯•..."
              sleep 20
            fi
          done
          
          if [ "$BUILD_SUCCESS" = false ]; then
            echo "âš ï¸ JitPackç¼–è¯‘è§¦å‘æœ€ç»ˆå¤±è´¥ï¼ˆéè‡´å‘½é”™è¯¯ï¼‰ï¼"
            echo "ğŸ”— æ‰‹åŠ¨è§¦å‘åœ°å€ï¼šhttps://jitpack.io/#${REPO_FULL_NAME}/${TAG_NAME}"
            echo "ğŸ”— ç¼–è¯‘æ—¥å¿—åœ°å€ï¼š${JITPACK_CHECK_URL}/build.log"
          fi
          exit 0

  # å‘å¸ƒaaråˆ°GitHub Packages
  publish-to-github-packages:
    runs-on: ubuntu-latest
    continue-on-error: false
    # ä»…ä¸»auto-releaseæˆåŠŸä¸”Tagä¸å­˜åœ¨æ—¶æ‰§è¡Œ
    needs: auto-release
    if: needs.auto-release.outputs.TAG_EXISTS == 'false' && needs.auto-release.result == 'success'
    steps:
      # æ­¥éª¤1ï¼šæ‹‰å–ä»£ç 
      - name: step_one -> æ‹‰å–ä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # æ­¥éª¤2ï¼šé…ç½®Android SDK
      - name: step_two -> é…ç½®Android SDK
        uses: android-actions/setup-android@v3

      # æ­¥éª¤3ï¼šç¼“å­˜Gradleä¾èµ–
      - name: step_three -> ç¼“å­˜Gradleä¾èµ–
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      # æ­¥éª¤4ï¼šåˆ›å»ºlocal.properties
      - name: step_four -> åˆ›å»ºAndroid SDKé…ç½®æ–‡ä»¶
        run: |
          echo "sdk.dir=${ANDROID_HOME}" > ${{ github.workspace }}/local.properties
          echo "âœ… å·²åˆ›å»ºlocal.propertiesï¼ŒSDKè·¯å¾„ï¼š${ANDROID_HOME}"

      # æ­¥éª¤5ï¼šå‘å¸ƒaaråˆ°GitHub Packages
      - name: step_five -> å‘å¸ƒaaråˆ°GitHub Packages
        run: |
          set -e  # é”™è¯¯ç«‹å³ç»ˆæ­¢ï¼Œä¾¿äºæ’æŸ¥
          echo "===== è°ƒè¯•å…³é”®ç¯å¢ƒå˜é‡ ====="
          echo "GITHUB_ACTOR: ${{ github.actor }}"
          echo "PUBLISH_MAVEN_USER: $PUBLISH_MAVEN_USER"
          echo "PUBLISH_MAVEN_KEYé•¿åº¦: ${#PUBLISH_MAVEN_KEY}"
          echo "å…³è”Tag: ${{ needs.auto-release.outputs.TAG_NAME }}"
          echo "ç‰ˆæœ¬å·: ${{ needs.auto-release.outputs.VERSION_NAME }}"
  
          # é…ç½®Mavenè®¤è¯ï¼ˆå…œåº•ä¿éšœï¼‰
          mkdir -p ~/.m2
          echo "<settings><servers><server><id>github</id><username>${{ github.actor }}</username><password>${{ secrets.GITHUB_TOKEN }}</password></server></servers></settings>" > ~/.m2/settings.xml
  
          # æå–ä»“åº“åï¼ˆä¿æŒåŸé€»è¾‘ï¼Œç¡®ä¿å‘å¸ƒä»»åŠ¡åæ­£ç¡®ï¼‰
          REPO_NAME=""
          PROPERTIES_OUTPUT=$(./gradlew :common:properties --no-daemon -q -Porg.gradle.logging.level=ERROR 2>/tmp/gradle_error.log)
          GRADLE_EXIT_CODE=$?
          if [ $GRADLE_EXIT_CODE -eq 0 ] && [ -n "$PROPERTIES_OUTPUT" ]; then
            REPO_NAME=$(echo "$PROPERTIES_OUTPUT" | awk '/publishing\.repositories\.maven\.name/ { gsub(/.*name[=:]\s*/, ""); gsub(/\r|\n/, ""); print $0 }')
          fi
          if [ -z "$REPO_NAME" ]; then
            REPO_NAME=$(grep 'name = "YaduoCommon"' common/build.gradle.kts | awk -F'"' '{print $2}')
          fi
          REPO_NAME=${REPO_NAME:-"YaduoCommon"}
          echo "âœ… æœ€ç»ˆä»“åº“åï¼š$REPO_NAME"

          # å…³é”®ï¼šå…ˆæ‰§è¡Œ publishToMavenLocal ç”Ÿæˆ POM æ–‡ä»¶åˆ°æœ¬åœ° Maven ä»“åº“
          echo "ğŸ“ ç”Ÿæˆ POM æ–‡ä»¶åˆ°æœ¬åœ° Maven ä»“åº“..."
          ./gradlew -PpublishToGitHubPackages=true :common:publishToMavenLocal --build-cache --info
      
          # æ‰“å° POM æ–‡ä»¶ï¼ˆæ­¤æ—¶å·²ç”Ÿæˆï¼Œè·¯å¾„æ­£ç¡®ï¼‰
          echo "ğŸ“ æ‰“å° POM æ–‡ä»¶å†…å®¹..."
          POM_PATH="~/.m2/repository/com/github/Yyaduo/YaduoCommon/${{ needs.auto-release.outputs.VERSION_NAME }}/YaduoCommon-${{ needs.auto-release.outputs.VERSION_NAME }}.pom"
          # å…¼å®¹è·¯å¾„ï¼šå¦‚æœæœ¬åœ°ä»“åº“æ²¡æœ‰ï¼Œè¯»å–æ„å»ºä¸´æ—¶ç›®å½•çš„ POM
          if [ ! -f "$POM_PATH" ]; then
          POM_PATH="${{ github.workspace }}/common/build/publications/release/pom-default.xml"
          echo "âš ï¸ æœ¬åœ°Mavenä»“åº“æ— POMï¼Œè¯»å–æ„å»ºä¸´æ—¶ç›®å½•ï¼š$POM_PATH"
          fi
          cat "$POM_PATH" || echo "âš ï¸ POM æ–‡ä»¶è¯»å–å¤±è´¥ï¼Œä½†ç»§ç»­å‘å¸ƒæµç¨‹..."
  
          # æ‰§è¡Œå‘å¸ƒä»»åŠ¡ï¼ˆè‡ªåŠ¨ä¾èµ–assembleReleaseï¼Œæ— éœ€å•ç‹¬æ„å»ºï¼‰
          PUBLISH_TASK=":common:publishReleasePublicationTo${REPO_NAME}Repository"
          echo "ğŸ“ æ‰§è¡Œå‘å¸ƒä»»åŠ¡ï¼š$PUBLISH_TASK"
          PUBLISH_MAVEN_USER="${{ github.actor }}" \
          PUBLISH_MAVEN_KEY="${{ secrets.GITHUB_TOKEN }}" \
          ./gradlew -PpublishToGitHubPackages=true $PUBLISH_TASK --build-cache --info
        env:
          # æ ¸å¿ƒè®¤è¯ç¯å¢ƒå˜é‡
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PUBLISH_MAVEN_USER: ${{ github.actor }}
          PUBLISH_MAVEN_KEY: ${{ secrets.GITHUB_TOKEN }}
          # Android SDKç¯å¢ƒå˜é‡
          ANDROID_HOME: ${{ env.ANDROID_HOME }}
          ANDROID_SDK_ROOT: ${{ env.ANDROID_HOME }}