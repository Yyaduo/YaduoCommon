# .github/workflows/auto-release.yml
name: è‡ªåŠ¨å‘å¸ƒRelease

# è§¦å‘æ¡ä»¶ï¼šPushåˆ°ç›®æ ‡åˆ†æ”¯
on:
  push:
    branches: [
      main,
      master,
      release-branch-v*,
    ]
    # åªç›‘å¬ç›¸å…³æ–‡ä»¶å˜æ›´æ—¶è§¦å‘å¹¶æ’é™¤æœ¬æ–‡ä»¶ä¿®æ”¹è§¦å‘
    paths:
      - 'app/build.gradle.kts'
      - 'common/build.gradle.kts'
      - 'gradle.properties'
      - '**.toml'
      - '**.kt'
      - '**.java'
      - '!.github/workflows/auto-release.yml'

# é…ç½®å·¥ä½œæµæƒé™
permissions:
  contents: write  # å…è®¸è¯»å†™ä»“åº“å†…å®¹ï¼ˆåˆ›å»ºTag/Releaseï¼‰

jobs:
  auto-release:
    runs-on: ubuntu-latest  # ç¼–è¯‘ç¯å¢ƒ
    # å¤±è´¥æ—¶ç«‹å³ç»ˆæ­¢ï¼Œé¿å…æ— æ•ˆæ­¥éª¤
    continue-on-error: false
    steps:
      # æ­¥éª¤1ï¼šæ‹‰å–ä»“åº“ä»£ç 
      - name: step_one -> æ‹‰å–ä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # æ‹‰å–æ‰€æœ‰å†å²ï¼Œæ–¹ä¾¿åˆ›å»ºTag
          # é…ç½®gitç”¨æˆ·ï¼ˆæå‰é…ç½®ï¼Œé¿å…åç»­é‡å¤ï¼‰
          persist-credentials: true

      # æ­¥éª¤2ï¼šè¯»å–ç‰ˆæœ¬å·
      - name: step_two -> è¯»å–ç‰ˆæœ¬å·
        id: get_version
        run: |
          # ä»»æ„å‘½ä»¤å¤±è´¥ç«‹å³é€€å‡º
          set -e 
          
          # ========== è¯»å–gradle.properties ==========
          # è¿‡æ»¤å‡ºVERSION_NAMEè¡Œ
          VERSION_LINE=$(grep '^VERSION_NAME=' gradle.properties)
          # æŒ‰ç­‰å·åˆ†å‰²ï¼Œå–ååŠéƒ¨åˆ†ï¼Œå»æ‰é¦–å°¾ç©ºæ ¼
          VERSION_NAME=$(echo "$VERSION_LINE" | cut -d'=' -f2 | tr -d ' ' | tr -d '\t')
          
          # ========== å¤‡ç”¨ï¼šè¯»å–build.gradle.kts==========
          if [ -z "$VERSION_NAME" ]; then
            echo "æœªä»gradle.propertiesè¯»å–ç‰ˆæœ¬å·ï¼Œå°è¯•è¯»å–common/build.gradle.kts..."
            # è¿‡æ»¤versionè¡Œ + æŒ‰å¼•å·åˆ†å‰² + å»ç©ºæ ¼
            VERSION_LINE=$(grep 'version =' common/build.gradle.kts | head -1)
            VERSION_NAME=$(echo "$VERSION_LINE" | cut -d'"' -f2 | tr -d ' ' | tr -d '\t')
          fi
          
          # æœ€ç»ˆæ ¡éªŒç‰ˆæœ¬å·
          if [ -z "$VERSION_NAME" ]; then
            echo "ERROR: æœªä»gradle.propertiesæˆ–build.gradle.ktsè¯»å–åˆ°ç‰ˆæœ¬å·ï¼"
            exit 1
          fi
          
          # ç”Ÿæˆå‘å¸ƒç›¸å…³å˜é‡
          TODAY_DATE=$(date +'%Y.%m.%d')
          TAG_NAME=release-v${VERSION_NAME}
          RELEASE_TITLE="${VERSION_NAME}-${TODAY_DATE}"
          
          # è¾“å‡ºå˜é‡ï¼ˆå…³é”®ï¼šè¡¥å……TODAY_DATEè¾“å‡ºï¼‰
          echo "VERSION_NAME=${VERSION_NAME}" >> $GITHUB_OUTPUT
          echo "TAG_NAME=${TAG_NAME}" >> $GITHUB_OUTPUT
          echo "RELEASE_TITLE=${RELEASE_TITLE}" >> $GITHUB_OUTPUT
          echo "TODAY_DATE=${TODAY_DATE}" >> $GITHUB_OUTPUT
          
          # æ‰“å°æ—¥å¿—ï¼ˆä¾¿äºæ’æŸ¥é—®é¢˜ï¼‰
          echo "===== å‘å¸ƒä¿¡æ¯ ====="
          echo "ç‰ˆæœ¬å·ï¼š${VERSION_NAME}"
          echo "Tagåç§°ï¼š${TAG_NAME}"
          echo "Releaseæ ‡é¢˜ï¼š${RELEASE_TITLE}"
          echo "å‘å¸ƒæ—¥æœŸï¼š${TODAY_DATE}"
          echo "===================="

      # æ­¥éª¤3ï¼šæ£€æŸ¥Tagæ˜¯å¦å·²å­˜åœ¨ï¼ˆé¿å…é‡å¤å‘å¸ƒï¼‰
      - name: step_three -> æ£€æŸ¥Tagæ˜¯å¦å­˜åœ¨
        id: check_tag
        run: |
          if git rev-parse "refs/tags/${{ steps.get_version.outputs.TAG_NAME }}" >/dev/null 2>&1; then
            echo "TAG_EXISTS=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ Tag ${{ steps.get_version.outputs.TAG_NAME }} å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º"
          else
            echo "TAG_EXISTS=false" >> $GITHUB_OUTPUT
            echo "âœ… Tag ${{ steps.get_version.outputs.TAG_NAME }} ä¸å­˜åœ¨ï¼Œå‡†å¤‡åˆ›å»º"
          fi

      # æ­¥éª¤4ï¼šåˆ›å»ºTagï¼ˆä»…Tagä¸å­˜åœ¨æ—¶æ‰§è¡Œï¼‰
      - name: step_four -> åˆ›å»ºGit Tag
        if: steps.check_tag.outputs.TAG_EXISTS == 'false'
        run: |
          set -e
          # 1. è·å–æœ¬æ¬¡æäº¤çš„ä½œè€…åç§°ï¼Œå…œåº•ç”¨GitHub Actor
          COMMIT_AUTHOR_NAME="${{ github.event.head_commit.author.name || github.actor }}"
          # 2. è·å–æœ¬æ¬¡æäº¤çš„ä½œè€…é‚®ç®±ï¼Œå…œåº•ç”¨ GitHub å®˜æ–¹noreplyé‚®ç®±
          COMMIT_AUTHOR_EMAIL="${{ github.event.head_commit.author.email || github.actor@users.noreply.github.com }}"
          
          git config --global user.name "$COMMIT_AUTHOR_NAME"
          git config --global user.email "$COMMIT_AUTHOR_EMAIL"
          
          # æ‰“å°é…ç½®çš„ç”¨æˆ·ä¿¡æ¯
          echo "ğŸ”§ é…ç½®çš„Gitç”¨æˆ·ä¿¡æ¯ï¼š"
          echo "   åç§°ï¼š$COMMIT_AUTHOR_NAME"
          echo "   é‚®ç®±ï¼š$COMMIT_AUTHOR_EMAIL"
          
          TAG_NAME="${{ steps.get_version.outputs.TAG_NAME }}"
          RELEASE_TITLE="${{ steps.get_version.outputs.RELEASE_TITLE }}"
          git tag -a "$TAG_NAME" -m "Release $RELEASE_TITLE"
          
          # æ¨é€Tag
          for i in {1..3}; do
            if git push origin ${{ steps.get_version.outputs.TAG_NAME }}; then
              echo "âœ… Tagæ¨é€æˆåŠŸ"
              break
            else
              echo "âš ï¸ Tagæ¨é€å¤±è´¥ï¼Œç¬¬${i}æ¬¡é‡è¯•..."
              sleep 2
              if [ $i -eq 3 ]; then
                echo "âŒ Tagæ¨é€3æ¬¡å¤±è´¥ï¼Œç»ˆæ­¢æµç¨‹"
                exit 1
              fi
            fi
          done

      # æ­¥éª¤5ï¼šåˆ›å»ºGitHub Releaseï¼ˆè‡ªåŠ¨å¡«å……Tag/Title/åˆ†æ”¯ï¼‰
      - name: step_five -> åˆ›å»ºRelease
        if: steps.check_tag.outputs.TAG_EXISTS == 'false'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.get_version.outputs.TAG_NAME }}
          name: ${{ steps.get_version.outputs.RELEASE_TITLE }}  # ä½¿ç”¨å¸¦æ—¥æœŸçš„æ ‡é¢˜
          target_commitish: ${{ github.ref_name }}
          # æ˜¾å¼é…ç½®å‘å¸ƒç±»å‹ï¼ˆéè‰ç¨¿/éé¢„å‘å¸ƒï¼‰
          draft: false
          prerelease: false
          body: |
            ## ${{ github.event.repository.name }} + ${{ steps.get_version.outputs.RELEASE_TITLE }}
            - å‘å¸ƒåˆ†æ”¯ï¼š${{ github.ref_name }}
            - æäº¤å“ˆå¸Œï¼š${{ github.sha }}
            - å‘å¸ƒæ—¥æœŸï¼š${{ steps.get_version.outputs.TODAY_DATE }}
            - æäº¤ä¿¡æ¯ï¼š${{ github.event.head_commit.message || 'æ— æäº¤ä¿¡æ¯' }}
            - JitPackä¾èµ–ç¤ºä¾‹ï¼š
              ```gradle
              dependencies {
                  implementation 'com.github.${{ github.repository_owner }}:${{ github.event.repository.name }}:${{ steps.get_version.outputs.TAG_NAME }}'
              }
              ```
              ```toml
              [libraries]
              yaduo-common = { module = "com.github.Yyaduo:YaduoCommon", version.ref = "yaduocommon" }
  
              [versions]
              yaduocommon = "${{ steps.get_version.outputs.TAG_NAME }}"
              ```