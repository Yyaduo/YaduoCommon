# .github/workflows/auto-release.yml
name: è‡ªåŠ¨å‘å¸ƒRelease

# è§¦å‘æ¡ä»¶ï¼šPushåˆ°ç›®æ ‡åˆ†æ”¯
on:
  push:
    branches: [
      main,
      master,
      release-branch-v*,
    ]
    # åªç›‘å¬ç›¸å…³æ–‡ä»¶å˜æ›´æ—¶è§¦å‘å¹¶æ’é™¤æœ¬æ–‡ä»¶ä¿®æ”¹è§¦å‘
    paths:
      - 'app/build.gradle.kts'
      - 'common/build.gradle.kts'
      - 'gradle.properties'
      - '**.toml'
      - '**.kt'
      - '**.java'
      - '!.github/workflows/auto-release.yml'

# é…ç½®å·¥ä½œæµæƒé™
permissions:
  contents: write  # å…è®¸è¯»å†™ä»“åº“å†…å®¹ï¼ˆåˆ›å»ºTag/Releaseï¼‰

jobs:
  auto-release:
    runs-on: ubuntu-latest  # ç¼–è¯‘ç¯å¢ƒ
    # å¤±è´¥æ—¶ç«‹å³ç»ˆæ­¢ï¼Œé¿å…æ— æ•ˆæ­¥éª¤
    continue-on-error: false
    steps:
      # æ­¥éª¤1ï¼šæ‹‰å–ä»“åº“ä»£ç 
      - name: step_one -> æ‹‰å–ä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # æ‹‰å–æ‰€æœ‰å†å²ï¼Œæ–¹ä¾¿åˆ›å»ºTag
          # é…ç½®gitç”¨æˆ·ï¼ˆæå‰é…ç½®ï¼Œé¿å…åç»­é‡å¤ï¼‰
          persist-credentials: true

      # æ­¥éª¤2ï¼šè¯»å–ç‰ˆæœ¬å·
      - name: step_two -> è¯»å–ç‰ˆæœ¬å·
        id: get_version
        run: |
          # ä»»æ„å‘½ä»¤å¤±è´¥ç«‹å³é€€å‡º
          set -e 
          
          # ========== è¯»å–gradle.properties ==========
          # è¿‡æ»¤å‡ºVERSION_NAMEè¡Œ
          VERSION_LINE=$(grep '^VERSION_NAME=' gradle.properties)
          # æŒ‰ç­‰å·åˆ†å‰²ï¼Œå–ååŠéƒ¨åˆ†ï¼Œå»æ‰é¦–å°¾ç©ºæ ¼
          VERSION_NAME=$(echo "$VERSION_LINE" | cut -d'=' -f2 | tr -d ' ' | tr -d '\t')
          
          # ========== å¤‡ç”¨ï¼šè¯»å–build.gradle.kts==========
          if [ -z "$VERSION_NAME" ]; then
            echo "æœªä»gradle.propertiesè¯»å–ç‰ˆæœ¬å·ï¼Œå°è¯•è¯»å–common/build.gradle.kts..."
            # è¿‡æ»¤versionè¡Œ + æŒ‰å¼•å·åˆ†å‰² + å»ç©ºæ ¼
            VERSION_LINE=$(grep 'version =' common/build.gradle.kts | head -1)
            VERSION_NAME=$(echo "$VERSION_LINE" | cut -d'"' -f2 | tr -d ' ' | tr -d '\t')
          fi
          
          # æœ€ç»ˆæ ¡éªŒç‰ˆæœ¬å·
          if [ -z "$VERSION_NAME" ]; then
            echo "ERROR: æœªä»gradle.propertiesæˆ–build.gradle.ktsè¯»å–åˆ°ç‰ˆæœ¬å·ï¼"
            exit 1
          fi
          
          # ç”Ÿæˆå‘å¸ƒç›¸å…³å˜é‡
          TODAY_DATE=$(date +'%Y.%m.%d')
          TAG_NAME=release-v${VERSION_NAME}
          RELEASE_TITLE="${VERSION_NAME}-${TODAY_DATE}"
          
          # è¾“å‡ºå˜é‡ï¼ˆå…³é”®ï¼šè¡¥å……TODAY_DATEè¾“å‡ºï¼‰
          echo "VERSION_NAME=${VERSION_NAME}" >> $GITHUB_OUTPUT
          echo "TAG_NAME=${TAG_NAME}" >> $GITHUB_OUTPUT
          echo "RELEASE_TITLE=${RELEASE_TITLE}" >> $GITHUB_OUTPUT
          echo "TODAY_DATE=${TODAY_DATE}" >> $GITHUB_OUTPUT
          
          # æ‰“å°æ—¥å¿—ï¼ˆä¾¿äºæ’æŸ¥é—®é¢˜ï¼‰
          echo "===== å‘å¸ƒä¿¡æ¯ ====="
          echo "ç‰ˆæœ¬å·ï¼š${VERSION_NAME}"
          echo "Tagåç§°ï¼š${TAG_NAME}"
          echo "Releaseæ ‡é¢˜ï¼š${RELEASE_TITLE}"
          echo "å‘å¸ƒæ—¥æœŸï¼š${TODAY_DATE}"
          echo "===================="

      # æ­¥éª¤3ï¼šæ£€æŸ¥Tagæ˜¯å¦å·²å­˜åœ¨ï¼ˆé¿å…é‡å¤å‘å¸ƒï¼‰
      - name: step_three -> æ£€æŸ¥Tagæ˜¯å¦å­˜åœ¨
        id: check_tag
        run: |
          if git rev-parse "refs/tags/${{ steps.get_version.outputs.TAG_NAME }}" >/dev/null 2>&1; then
            echo "TAG_EXISTS=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ Tag ${{ steps.get_version.outputs.TAG_NAME }} å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º"
          else
            echo "TAG_EXISTS=false" >> $GITHUB_OUTPUT
            echo "âœ… Tag ${{ steps.get_version.outputs.TAG_NAME }} ä¸å­˜åœ¨ï¼Œå‡†å¤‡åˆ›å»º"
          fi

      # æ­¥éª¤4ï¼šåˆ›å»ºTagï¼ˆä»…Tagä¸å­˜åœ¨æ—¶æ‰§è¡Œï¼‰
      - name: step_four -> åˆ›å»ºGit Tag
        id: build_release
        if: steps.check_tag.outputs.TAG_EXISTS == 'false'
        run: |
          set -e
          # 1. è·å–æœ¬æ¬¡æäº¤çš„ä½œè€…åç§°ï¼Œå…œåº•ç”¨GitHub Actor
          COMMIT_AUTHOR_NAME="${{ github.event.head_commit.author.name || github.actor }}"
          # 2. è·å–æœ¬æ¬¡æäº¤çš„ä½œè€…é‚®ç®±ï¼Œå…œåº•ç”¨ GitHub å®˜æ–¹noreplyé‚®ç®±
          COMMIT_AUTHOR_EMAIL="${{ github.event.head_commit.author.email }}"
          if [ -z "$COMMIT_AUTHOR_EMAIL" ]; then
            COMMIT_AUTHOR_EMAIL="${{ github.actor }}@users.noreply.github.com"
          fi
          
          git config --global user.name "$COMMIT_AUTHOR_NAME"
          git config --global user.email "$COMMIT_AUTHOR_EMAIL"
          
          # è¾“å‡ºæäº¤çš„ç”¨æˆ·ä¿¡æ¯
          echo "commit_author_name=${COMMIT_AUTHOR_NAME}" >> $GITHUB_OUTPUT
          echo "commit_author_email=${COMMIT_AUTHOR_EMAIL}" >> $GITHUB_OUTPUT
          
          # æ‰“å°é…ç½®çš„ç”¨æˆ·ä¿¡æ¯
          echo "ğŸ”§ é…ç½®çš„Gitç”¨æˆ·ä¿¡æ¯ï¼š"
          echo "   åç§°ï¼š$COMMIT_AUTHOR_NAME"
          echo "   é‚®ç®±ï¼š$COMMIT_AUTHOR_EMAIL"
          
          TAG_NAME="${{ steps.get_version.outputs.TAG_NAME }}"
          RELEASE_TITLE="${{ steps.get_version.outputs.RELEASE_TITLE }}"
          git tag -a "$TAG_NAME" -m "Release $RELEASE_TITLE"
          
          # æ¨é€Tag
          for i in {1..3}; do
            if git push origin ${{ steps.get_version.outputs.TAG_NAME }}; then
              echo "âœ… Tagæ¨é€æˆåŠŸ"
              break
            else
              echo "âš ï¸ Tagæ¨é€å¤±è´¥ï¼Œç¬¬${i}æ¬¡é‡è¯•..."
              sleep 2
              if [ $i -eq 3 ]; then
                echo "âŒ Tagæ¨é€3æ¬¡å¤±è´¥ï¼Œç»ˆæ­¢æµç¨‹"
                exit 1
              fi
            fi
          done

      # æ­¥éª¤5ï¼šåˆ›å»ºGitHub Releaseï¼ˆè‡ªåŠ¨å¡«å……Tag/Title/åˆ†æ”¯ï¼‰
      - name: step_five -> åˆ›å»ºRelease
        if: steps.check_tag.outputs.TAG_EXISTS == 'false'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.get_version.outputs.TAG_NAME }}
          name: ${{ steps.get_version.outputs.RELEASE_TITLE }}  # ä½¿ç”¨å¸¦æ—¥æœŸçš„æ ‡é¢˜
          target_commitish: ${{ github.ref_name }}
          # æ˜¾å¼é…ç½®å‘å¸ƒç±»å‹ï¼ˆéè‰ç¨¿/éé¢„å‘å¸ƒï¼‰
          draft: false
          prerelease: false
          body: |
            ## ${{ github.event.repository.name }} : ${{ steps.get_version.outputs.RELEASE_TITLE }}
            - å‘å¸ƒåˆ†æ”¯ï¼š${{ github.ref_name }}
            - æäº¤å“ˆå¸Œï¼š${{ github.sha }}
            - å‘å¸ƒæ—¥æœŸï¼š${{ steps.get_version.outputs.TODAY_DATE }}
            - ä»£ç æäº¤ä½œè€…ï¼š${{ steps.build_release.outputs.commit_author_name }} <${{ steps.build_release.outputs.commit_author_email }}>
            - Release åˆ›å»ºè€…ï¼šGitHub Actionsï¼ˆè‡ªåŠ¨åŒ–å‘å¸ƒï¼‰
            - æäº¤ä¿¡æ¯ï¼š${{ github.event.head_commit.message || 'æ— æäº¤ä¿¡æ¯' }}
            - JitPackä¾èµ–ç¤ºä¾‹ï¼š
              ```gradle
              dependencies {
                  implementation 'com.github.${{ github.repository_owner }}:${{ github.event.repository.name }}:${{ steps.get_version.outputs.TAG_NAME }}'
              }
              ```
              ```toml
              [libraries]
              yaduo-common = { module = "com.github.Yyaduo:YaduoCommon", version.ref = "yaduocommon" }
  
              [versions]
              yaduocommon = "${{ steps.get_version.outputs.TAG_NAME }}"
              ```
      - name: step_six -> è§¦å‘ JitPack ç¼–è¯‘
        # ä»…å½“ Tag ä¸å­˜åœ¨ï¼ˆåˆ›å»ºäº†æ–° Releaseï¼‰ä¸”å‰åºæ­¥éª¤æˆåŠŸæ—¶æ‰§è¡Œ
        if: steps.check_tag.outputs.TAG_EXISTS == 'false' && success()
        run: |
          set -e
          # æ„é€  JitPack ç¼–è¯‘ API åœ°å€
          REPO_FULL_NAME="${{ github.repository }}"  # æ ¼å¼ï¼šç”¨æˆ·å/ä»“åº“å
          TAG_NAME="${{ steps.get_version.outputs.TAG_NAME }}"
          JITPACK_API_URL="https://jitpack.io/api/builds/${REPO_FULL_NAME}/${TAG_NAME}"

          echo "===== è§¦å‘JitPackç¼–è¯‘ ====="
          echo "ä»“åº“åœ°å€ï¼š${REPO_FULL_NAME}"
          echo "Tagç‰ˆæœ¬ï¼š${TAG_NAME}"
          echo "JitPack APIï¼š${JITPACK_API_URL}"
          echo "==========================="

          # å‰ç½®æ£€æŸ¥ï¼šç¡®è®¤Tagå·²æ¨é€åˆ°è¿œç¨‹ï¼ˆå»¶è¿Ÿ5ç§’ï¼Œç­‰å¾…GitHubåŒæ­¥ï¼‰
          echo "ğŸ” æ£€æŸ¥è¿œç¨‹Tagæ˜¯å¦å­˜åœ¨..."
          sleep 5
          if git ls-remote --tags origin "${TAG_NAME}" | grep -q "${TAG_NAME}"; then
            echo "âœ… è¿œç¨‹Tagå·²å­˜åœ¨ï¼Œç»§ç»­è§¦å‘ç¼–è¯‘"
          else
            echo "âš ï¸ è¿œç¨‹TagæœªåŒæ­¥ï¼Œå»¶è¿Ÿ10ç§’åé‡è¯•æ£€æŸ¥..."
            sleep 10
            if ! git ls-remote --tags origin "${TAG_NAME}" | grep -q "${TAG_NAME}"; then
              echo "âŒ è¿œç¨‹TagåŒæ­¥å¤±è´¥ï¼Œè·³è¿‡JitPackè§¦å‘ï¼ˆé¿å…æ— æ•ˆè¯·æ±‚ï¼‰"
              exit 0  # è·³è¿‡å¤±è´¥ï¼Œä¸ç»ˆæ­¢æ•´ä¸ªå·¥ä½œæµ
            fi
          fi
          
          # å‘é€POSTè¯·æ±‚è§¦å‘ç¼–è¯‘ï¼ˆé‡è¯•3æ¬¡ï¼Œé¿å…ç½‘ç»œé—®é¢˜ï¼‰
          for i in {1..3}; do
            echo "ğŸ“¡ ç¬¬${i}æ¬¡å°è¯•è§¦å‘JitPackç¼–è¯‘..."
            # å¢åŠ è¶…æ—¶ã€è¯¦ç»†è¾“å‡ºã€SSLå®¹é”™ã€User-Agent
            RESPONSE=$(curl -s -X POST \
              --connect-timeout 10 \
              --max-time 30 \
              -k \
              -H "User-Agent: GitHub Actions/${{ github.run_id }} (${{ github.actor }})" \
              -H "Accept: application/json" \
              "$JITPACK_API_URL")
          
            # æ‰“å°è°ƒè¯•ä¿¡æ¯
            echo "ğŸ“ JitPackå“åº”ï¼ˆåŸå§‹ï¼‰ï¼š${RESPONSE:-"ç©ºå“åº”"}"
          
            # å®½æ¾çš„æˆåŠŸåˆ¤æ–­ï¼ˆç©ºå“åº”ä¹Ÿå°è¯•è·³è¿‡ï¼Œé¿å…è¯¯åˆ¤ï¼‰
            if [ -n "$RESPONSE" ] && echo "$RESPONSE" | grep -qiE "Building|Queued|Success|Created|Found"; then
              echo "âœ… JitPackç¼–è¯‘è§¦å‘æˆåŠŸï¼å“åº”ï¼š${RESPONSE}"
              break
            elif [ -z "$RESPONSE" ]; then
              echo "âš ï¸ ç¬¬${i}æ¬¡è§¦å‘ï¼šJitPackå“åº”ä¸ºç©ºï¼ˆå¯èƒ½æ˜¯ç½‘ç»œ/æœåŠ¡ä¸´æ—¶é—®é¢˜ï¼‰"
              sleep 5  # ç©ºå“åº”æ—¶å»¶é•¿é‡è¯•é—´éš”
            else
              echo "âš ï¸ ç¬¬${i}æ¬¡è§¦å‘å¤±è´¥ï¼Œå“åº”ï¼š${RESPONSE}"
              sleep 5
            fi
          
            # æœ€åä¸€æ¬¡é‡è¯•å¤±è´¥æ—¶ï¼Œä¸ç»ˆæ­¢æ•´ä¸ªå·¥ä½œæµï¼ˆä»…è­¦å‘Šï¼‰
            if [ $i -eq 3 ]; then
              echo "âš ï¸ JitPackç¼–è¯‘è§¦å‘3æ¬¡å¤±è´¥ï¼ˆéè‡´å‘½é”™è¯¯ï¼‰ï¼Œè¯·æ‰‹åŠ¨è®¿é—®ä»¥ä¸‹åœ°å€è§¦å‘ï¼š"
              echo "ğŸ”— JitPackæ‰‹åŠ¨è§¦å‘åœ°å€ï¼šhttps://jitpack.io/#${REPO_FULL_NAME}/${TAG_NAME}"
              echo "ğŸ”— ç¼–è¯‘æ—¥å¿—åœ°å€ï¼šhttps://jitpack.io/com/github/${{ github.repository_owner }}/${{ github.event.repository.name }}/${TAG_NAME}/build.log"
              exit 0  # é€€å‡ºç 0ï¼Œä¸ç»ˆæ­¢å·¥ä½œæµ
            fi
          done

          # æ‰“å°JitPackç¼–è¯‘çŠ¶æ€æŸ¥è¯¢åœ°å€ï¼Œæ–¹ä¾¿æ’æŸ¥
          JITPACK_STATUS_URL="https://jitpack.io/com/github/${{ github.repository_owner }}/${{ github.event.repository.name }}/${TAG_NAME}"
          echo "ğŸ“Œ JitPackç¼–è¯‘çŠ¶æ€æŸ¥è¯¢ï¼š${JITPACK_STATUS_URL}"
          echo "ğŸ“Œ JitPackç¼–è¯‘æ—¥å¿—æŸ¥è¯¢ï¼š${JITPACK_STATUS_URL}/build.log"